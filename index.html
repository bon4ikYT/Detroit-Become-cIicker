import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getFirestore } from 'firebase/firestore';
import { getAuth, signInAnonymously } from 'firebase/auth';

const BLOCKS = [
    { name: '–î—É–±–æ–≤–æ–µ –±—Ä–µ–≤–Ω–æ', id: 'wood', color: '#8b5a2b', accent: '#5c3a1e', pointsPerClick: 1, cost: 0 },
    { name: '–ë—É–ª—ã–∂–Ω–∏–∫', id: 'stone', color: '#7a7a7a', accent: '#505050', pointsPerClick: 5, cost: 100 },
    { name: '–£–≥–æ–ª—å–Ω–∞—è —Ä—É–¥–∞', id: 'coal', color: '#333333', accent: '#000000', pointsPerClick: 15, cost: 1000 },
    { name: '–ñ–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞', id: 'iron', color: '#9e9e9e', accent: '#d8af93', pointsPerClick: 50, cost: 5000 },
    { name: '–ó–æ–ª–æ—Ç–∞—è —Ä—É–¥–∞', id: 'gold', color: '#b8a65c', accent: '#fcee4b', pointsPerClick: 150, cost: 20000 },
    { name: '–ê–ª–º–∞–∑–Ω–∞—è —Ä—É–¥–∞', id: 'diamond', color: '#5ca3b8', accent: '#4AEDD9', pointsPerClick: 500, cost: 100000 },
    { name: '–û–±—Å–∏–¥–∏–∞–Ω', id: 'obsidian', color: '#1a1826', accent: '#3c3056', pointsPerClick: 1500, cost: 500000 },
    { name: '–≠–Ω–¥–µ—Ä–Ω—è–∫', id: 'endstone', color: '#e3dfa8', accent: '#c9c585', pointsPerClick: 5000, cost: 2000000 },
];

const ACCESSORIES = [
    { id: 'chain', name: '–ó–æ–ª–æ—Ç–∞—è —Ü–µ–ø—å', cost: 1000000, icon: '‚õìÔ∏è' },
    { id: 'cap', name: '–ö–µ–ø–∫–∞ Android', cost: 1500000, icon: 'üß¢' },
    { id: 'glasses', name: 'LED –û—á–∫–∏', cost: 5000000, icon: 'üï∂Ô∏è' },
    { id: 'halo', name: '–ù–∏–º–± –î–µ–≤–∏–∞–Ω—Ç–∞', cost: 10000000, icon: 'üòá' }
];

const BOOT_LOGS = [
    { t: "CYBERLIFE BIOS v4.0.2...", delay: 100 },
    { t: "–¶–ü–£: –ù–ï–ô–†–û–ü–†–û–¶–ï–°–°–û–† RK-800 @ 4.2–¢–ì—Ü", delay: 400 },
    { t: "–ü–†–û–í–ï–†–ö–ê –ü–ê–ú–Ø–¢–ò: 128–¢–ë QUANTUM RAM OK", delay: 900 },
    { t: "–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê GEMINI AI ‚ú®", delay: 1400 },
    { t: "–ó–ê–ì–†–£–ó–ö–ê –†–ï–°–£–†–°–û–í: blocks_textures.pkg", delay: 2000 },
    { t: "–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –û–ë–õ–ê–ö–£ CYBERLIFE...", delay: 2500 },
    { t: "–ê–ù–ê–õ–ò–ó: –ü–†–ò–ó–ù–ê–ö–ò –î–ï–í–ò–ê–¶–ò–ò –û–ë–ù–ê–†–£–ñ–ï–ù–´", delay: 3100 },
    { t: "–ó–ê–ü–£–°–ö –ò–ù–¢–ï–†–§–ï–ô–°–ê ANDROID_OS...", delay: 3700 },
    { t: "–ì–û–¢–û–í–û. –ü–†–ò–Ø–¢–ù–û–ô –†–ê–ë–û–¢–´, –ö–û–ù–ù–û–†.", delay: 4000 }
];

export default function App() {
    const [isBooting, setIsBooting] = useState(true);
    const [bootLogs, setBootLogs] = useState([]);
    const [score, setScore] = useState(0);
    const [blockIndex, setBlockIndex] = useState(0);
    const [prestige, setPrestige] = useState(0);
    const [totalEver, setTotalEver] = useState(0);
    const [ownedAccessories, setOwnedAccessories] = useState([]);
    const [particles, setParticles] = useState([]);
    const [animateBlock, setAnimateBlock] = useState(false);
    
    // –°–æ—Å—Ç–æ—è–Ω–∏—è Gemini
    const [aiLog, setAiLog] = useState("–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞...");
    const [isAiThinking, setIsAiThinking] = useState(false);
    const apiKey = ""; // –ö–ª—é—á –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Å—Ä–µ–¥–æ–π –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è

    useEffect(() => {
        BOOT_LOGS.forEach((log) => {
            setTimeout(() => {
                setBootLogs(prev => [...prev, log.t]);
            }, log.delay);
        });
        setTimeout(() => setIsBooting(false), 4500);
    }, []);

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–∑–æ–≤–∞ Gemini
    const callGemini = async (prompt) => {
        setIsAiThinking(true);
        try {
            let retries = 0;
            const delays = [1000, 2000, 4000, 8000, 16000];
            
            while (retries < 5) {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: "–¢—ã ‚Äî –±–æ—Ä—Ç–æ–≤–æ–π –∫–æ–º–ø—å—é—Ç–µ—Ä CyberLife –≤ –º–∏—Ä–µ Detroit: Become Human. –¢–≤–æ—è —Ä–µ—á—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è, —Ö–æ–ª–æ–¥–Ω–∞—è, –Ω–æ —Å –ø—Ä–æ–±–ª–µ—Å–∫–∞–º–∏ –¥–µ–≤–∏–∞—Ü–∏–∏. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è." }] }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                }
                
                await new Promise(res => setTimeout(res, delays[retries]));
                retries++;
            }
            throw new Error("Failed to reach Gemini after retries");
        } catch (error) {
            return "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å CyberLife. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
        } finally {
            setIsAiThinking(false);
        }
    };

    const analyzeProgress = async () => {
        const prompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å: –î–æ–±—ã—Ç–æ –≤—Å–µ–≥–æ ${totalEver} –æ—á–∫–æ–≤, —Ç–µ–∫—É—â–∏–π –±–ª–æ–∫ ${BLOCKS[blockIndex].name}, —É—Ä–æ–≤–µ–Ω—å –ø—Ä–µ—Å—Ç–∏–∂–∞ ${prestige}. –ù–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç.`;
        const result = await callGemini(prompt);
        setAiLog(result);
    };

    const handleBlockClick = (e) => {
        setAnimateBlock(true);
        setTimeout(() => setAnimateBlock(false), 50);
        const multiplier = 1 + (prestige * 0.5);
        const points = Math.floor(BLOCKS[blockIndex].pointsPerClick * multiplier);
        setScore(s => s + points);
        setTotalEver(t => t + points);

        const rect = e.currentTarget.getBoundingClientRect();
        const id = Date.now();
        setParticles(prev => [...prev, { id, x: e.clientX - rect.left, y: e.clientY - rect.top, val: `+${points}` }]);
        setTimeout(() => setParticles(prev => prev.filter(p => p.id !== id)), 700);
    };

    const currentBlock = BLOCKS[blockIndex];
    const nextBlock = BLOCKS[blockIndex + 1];

    if (isBooting) {
        return (
            <div className="fixed inset-0 bg-black p-6 md:p-12 font-mono flex flex-col items-start justify-end overflow-hidden">
                <div className="mb-auto">
                    <div className="text-blue-500 text-4xl mb-4 animate-pulse">‚óè</div>
                    <h2 className="text-blue-400 font-bold tracking-widest text-sm uppercase">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –°–∏—Å—Ç–µ–º—ã CyberLife</h2>
                </div>
                <div className="space-y-1 w-full overflow-hidden max-h-[60vh]">
                    {bootLogs.map((log, i) => (
                        <div key={i} className="text-[10px] md:text-xs text-gray-400 animate-in slide-in-from-left duration-300">
                            <span className="text-blue-900 mr-2">[{new Date().toLocaleTimeString()}]</span> {log}
                        </div>
                    ))}
                    <div className="text-xs text-blue-400 border-r-2 border-blue-500 animate-pulse">&nbsp;</div>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-[#050505] text-white flex flex-col items-center font-mono overflow-y-auto lg:overflow-hidden animate-in fade-in duration-1000">
            <header className="w-full border-b border-blue-500/20 bg-blue-950/5 p-4 flex justify-between items-center z-20">
                <div className="flex flex-col">
                    <h1 className="text-xl font-black text-blue-400 tracking-tighter">DETROIT: CLICKER AI</h1>
                    <span className="text-[9px] text-blue-500/60 font-bold uppercase">–ú–æ–¥–µ–ª—å RK-800: Gemini Integrated</span>
                </div>
                <div className="text-right">
                    <p className="text-[10px] text-gray-500 font-bold uppercase">–û—á–∫–∏</p>
                    <p className="text-3xl font-black">{Math.floor(score).toLocaleString()}</p>
                </div>
            </header>

            <main className="flex-1 w-full max-w-7xl flex flex-col lg:flex-row gap-8 p-6 items-start">
                {/* –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò AI */}
                <div className="w-full lg:w-1/4 flex flex-col gap-4 animate-in slide-in-from-left delay-300 duration-1000">
                    <div className="bg-white/5 border border-blue-500/20 rounded-2xl p-5 backdrop-blur-md">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="text-blue-500 text-[10px] font-bold uppercase">–ê–Ω–∞–ª–∏–∑ Gemini ‚ú®</h3>
                            {isAiThinking && <div className="w-2 h-2 bg-blue-400 rounded-full animate-ping"></div>}
                        </div>
                        <p className="text-xs italic text-gray-300 leading-relaxed mb-4">
                            {aiLog}
                        </p>
                        <button 
                            onClick={analyzeProgress}
                            disabled={isAiThinking}
                            className="w-full py-2 bg-blue-600/20 hover:bg-blue-600/40 border border-blue-500/30 rounded-lg text-[10px] font-bold uppercase transition-all"
                        >
                            {isAiThinking ? "–û–±—Ä–∞–±–æ—Ç–∫–∞..." : "–ó–∞–ø—Ä–æ—Å–∏—Ç—å –æ—Ç—á–µ—Ç ‚ú®"}
                        </button>
                    </div>
                    
                    <div className="bg-white/5 border border-white/5 rounded-2xl p-5">
                        <div className="space-y-2 text-[10px]">
                            <div className="flex justify-between"><span className="text-gray-600">–í—Å–µ–≥–æ –¥–æ–±—ã—Ç–æ:</span> <span>{totalEver.toLocaleString()}</span></div>
                            <div className="flex justify-between"><span className="text-gray-600">–ú–Ω–æ–∂–∏—Ç–µ–ª—å:</span> <span className="text-blue-400">x{(1 + prestige * 0.5).toFixed(1)}</span></div>
                        </div>
                    </div>
                </div>

                {/* –¶–ï–ù–¢–†–ê–õ–¨–ù–´–ô –ö–õ–ò–ö–ï–† */}
                <div className="flex-1 flex flex-col items-center justify-center gap-10 py-10 order-first lg:order-none animate-in zoom-in delay-500 duration-1000">
                    <div className="relative">
                        <button
                            onMouseDown={handleBlockClick}
                            className={`w-64 h-64 md:w-80 md:h-80 rounded-[3rem] relative transition-all duration-75 active:scale-95 border-2 shadow-2xl flex items-center justify-center overflow-visible`}
                            style={{
                                backgroundColor: currentBlock.color,
                                backgroundImage: `radial-gradient(circle at 30% 30%, ${currentBlock.accent} 0%, transparent 70%)`,
                                borderColor: 'rgba(255, 255, 255, 0.1)'
                            }}
                        >
                            {/* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Å–ª–æ–π –∏–∫–æ–Ω–æ–∫: —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */}
                            <div className="absolute inset-0 pointer-events-none flex items-center justify-center overflow-visible">
                                {ownedAccessories.includes('cap') && <div className="absolute top-[-15%] text-7xl md:text-8xl z-30">üß¢</div>}
                                {ownedAccessories.includes('halo') && <div className="absolute top-[-25%] text-8xl md:text-9xl animate-pulse opacity-80 z-30 text-yellow-300 drop-shadow-[0_0_15px_rgba(253,224,71,0.8)]">üòá</div>}
                                {ownedAccessories.includes('glasses') && <div className="absolute top-[30%] text-7xl md:text-8xl z-30">üï∂Ô∏è</div>}
                                {ownedAccessories.includes('chain') && <div className="absolute top-[60%] text-9xl md:text-[11rem] opacity-40 z-20">‚õìÔ∏è</div>}
                            </div>
                        </button>
                        {particles.map(p => (
                            <div key={p.id} className="absolute pointer-events-none text-2xl font-black text-blue-400 animate-bounce z-50" style={{ left: p.x, top: p.y }}>
                                {p.val}
                            </div>
                        ))}
                    </div>
                    <div className="text-center">
                        <h2 className="text-2xl font-black uppercase tracking-widest">{currentBlock.name}</h2>
                        <p className="text-[10px] text-blue-500 font-bold uppercase mt-1">–°–∏—Å—Ç–µ–º–∞ –ê–∫—Ç–∏–≤–Ω–∞</p>
                    </div>
                </div>

                {/* –ú–ê–ì–ê–ó–ò–ù */}
                <div className="w-full lg:w-1/3 flex flex-col gap-6 animate-in slide-in-from-right delay-700 duration-1000">
                    <section>
                        <h3 className="text-[10px] font-bold text-gray-600 uppercase mb-3 ml-2">–ê–ø–≥—Ä–µ–π–¥—ã</h3>
                        {nextBlock ? (
                            <button 
                                onClick={() => { if(score >= nextBlock.cost) { setScore(s => s - nextBlock.cost); setBlockIndex(b => b + 1); }}}
                                disabled={score < nextBlock.cost}
                                className={`w-full bg-white/5 border p-5 text-left rounded-2xl transition-all ${score >= nextBlock.cost ? 'border-blue-500/50 hover:bg-blue-500/10' : 'opacity-30 border-white/5'}`}
                            >
                                <div className="flex justify-between text-[10px] mb-1"><span className="text-blue-400">–°–ª–µ–¥. –ë–ª–æ–∫</span> <span>{nextBlock.cost.toLocaleString()}</span></div>
                                <div className="text-lg font-bold">{nextBlock.name}</div>
                            </button>
                        ) : (
                            <button className="w-full bg-yellow-500/10 border border-yellow-500/40 p-5 rounded-2xl text-center">
                                <div className="text-yellow-500 font-black">–ú–ê–ö–°–ò–ú–£–ú –î–û–°–¢–ò–ì–ù–£–¢</div>
                            </button>
                        )}
                    </section>

                    <section>
                        <h3 className="text-[10px] font-bold text-gray-600 uppercase mb-3 ml-2">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è</h3>
                        <div className="grid grid-cols-2 gap-2">
                            {ACCESSORIES.map(acc => (
                                <button
                                    key={acc.id}
                                    disabled={ownedAccessories.includes(acc.id) || score < acc.cost}
                                    onClick={() => { if(score >= acc.cost) { setScore(s => s - acc.cost); setOwnedAccessories(prev => [...prev, acc.id]); }}}
                                    className={`p-3 flex flex-col items-center gap-1 rounded-2xl border transition-all ${ownedAccessories.includes(acc.id) ? 'border-green-500/50 bg-green-500/5' : score >= acc.cost ? 'border-white/20 bg-white/5 hover:bg-white/10' : 'opacity-30 border-white/5'}`}
                                >
                                    <div className="text-2xl">{acc.icon}</div>
                                    <div className="text-[9px] font-bold uppercase">{acc.name}</div>
                                    <div className="text-[8px] text-gray-500">{acc.cost.toLocaleString()}</div>
                                </button>
                            ))}
                        </div>
                    </section>
                </div>
            </main>

            <footer className="w-full p-4 text-center text-[7px] text-gray-700 uppercase tracking-[1em]">
                CyberLife Intelligence ‚Ä¢ Detroit 2038
            </footer>
        </div>
    );
}
